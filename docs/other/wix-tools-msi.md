---
layout: page
title: Wix - Wix 3 Installer
parent: Other
---

# Wix 3 Installer

The Wix (Windows Installer XML) tool set is used to build MSI packages for your software. You can add a wixproj besides your main C# projects and define what you want to be installed, where you want it and even if you want to create shortcuts for your software. The generated MSI package can be built in an automated process, like the DevOps CI build pipe.


# Getting started

Download the Toolkit on [GitHub Releases](https://github.com/wixtoolset/wix3/releases/). The tool set is already installed for the `Windows-latest` Azure Container images for your CI build pipe on DevOps. 

***optional* VS extensions**
You can also install the VS extensions [WiX v3 VS Studio Extension](https://wixtoolset.org/docs/wix3/) and the [Wax Extension](https://github.com/tom-englert/Wax). 

[![VS Extensions](/assets/images/articles/wix-tools-msi/VS-Extensions.png)](/assets/images/articles/wix-tools-msi/VS-Extensions.png)

Create a project template besides your C# project for the MSI setup. This will create a project with a `wsx` file. This file describes the setup process, the components and all the rest to create a good MSI package.

WiX has its own 'compiler' and 'linker' called `candle.exe` and `light.exe`. You could interact with them per CLI, but you can also just use your VS and the default build tasks in your CI build pipe to create the MSI setup file.


# Creating a MSI with an example

I have an example project with a console application, a library and the Wix project. The Wix project references the console app and the app references its library.
It uses Nerdbank Git Versioning for automatic versioning stamps of the assemblies. It is possible to use the generated Version number for the Wix MSI as well to keep these in sync (recommended).


## wxs file and content

The MSI package contains so called features. These contain Component Groups, the groups contain Components and all of this can be separated in Fragments. 

If you activate and use UI dialogs, you can let the user decide if features should be installed or not (not explained here yet).


### Product 

The `wsx` file contains the Product information with an GUID id for the setup. This can be autogenerated with an Asterix `*`. The Name attribute contains the Product Name of your software. The Manufacturer won't change very often, so it can be hardcoded, like the Product Name. The UpgradeCode is another GUID to be set for each setup. It identifies the product for the OS to know this exact product and must stay the same for each new Version. The OS compares this and the Version number to decide if the product install process is an upgrade or to prevent downgrades of the software.


#### Variable definitions

The needed variables are defined on top of the `Product.wxs` file to improve the maintenance.

```xml
<?define ProductName="WixInstallerEDU" ?>
<?define ProductManufacturer="YOUR COMPANY HERE" ?>
<?define ProductVersion="!(bind.FileVersion.MainExeFile)" ?>
<?define ProductTargetDir=$(var.WixInstallerEDU.TargetDir) ?>
<?define ProductProjectIconDir=$(var.WixInstallerEDU.ProjectDir) ?>
<?define ProductHelpLink=https://dev.azure.com/OttoChemie/Ausbildung/_git/WixInstallerEDU?>
```

#### Pack the MSI to single file

The MSI would have a cab archive file per default, but with the `<MediaTemplate EmbedCab="yes" />` setting the cab archive will be built within the MSI package to only have a single output file. 


#### AppIcon and links

If you have an icon file for you application, you can add it to be displayed in the OS application install/uninstall dialog. The setup can also contain help links for further information (`$(var.ProductHelpLink)` is defined on the top of the file):

```xml
<!-- Set the icon to be used in "Programs and Features" -->
<Icon Id="AppIcon" SourceFile="$(var.ProductProjectIconDir)Resources\Logo.ico" />
<Property Id="ARPPRODUCTICON" Value="AppIcon" />

<!-- Provide information links to be displayed in "Programs and Features" -->
<Property Id="ARPURLINFOABOUT"  Value="$(var.ProductHelpLink)" />
<Property Id="ARPHELPLINK"      Value="$(var.ProductHelpLink)" />
<Property Id="ARPURLUPDATEINFO" Value="$(var.ProductHelpLink)" />
```

[![OS App dialog](/assets/images/articles/wix-tools-msi/OS-App-Dialog.png)](/assets/images/articles/wix-tools-msi/OS-App-Dialog.png)


#### Changing Icons and shortcuts for environments

The example part shows how to determine for which environment the setup should be built. This gets controlled via Environment variable, either a local one on the developer machine, or the one set in the CI build Pipe in DevOps. This part the sets the right Shortcut name for Desktop and the Start Menu entry:

```xml
<?ifdef env.SETUP_ENVIRONMENT?>
<?if $(env.SETUP_ENVIRONMENT)=DEVELOPMENT?>
<?define ShortcutName="$(var.ProductName) - DEV" ?>
<?endif?>
<?if $(env.SETUP_ENVIRONMENT)=BETA?>
<?define ShortcutName="$(var.ProductName) - BETA" ?>
<?endif?>
<?else?>
<?define ShortcutName="$(var.ProductName)" ?>
<?endif?>
```

This uses the preprocessor checks of the WiX tool set: [Wix preprocessor Docu](https://wixtoolset.org/docs/v3/overview/preprocessor/)

Same procedure for the Icons:

```xml
<?ifdef env.SETUP_ENVIRONMENT?>
<?if $(env.SETUP_ENVIRONMENT)!=""?>
<Icon Id="AppIcon" SourceFile="$(var.ProductProjectIconDir)Icon_BETA.ico" />
<Property Id="ARPPRODUCTICON" Value="AppIcon" />
<?endif?>
<?else?>
<Icon Id="AppIcon" SourceFile="$(var.ProductProjectIconDir)Icon.ico" />
<Property Id="ARPPRODUCTICON" Value="AppIcon" />
<?endif?>
```


#### Directories

The next part defines the directories where you want to install your software. A good practice is to use the Wix shortcuts to ensure language independent pathing, aswell as a manufacturer folder and a product named folder. You can also set a shortcut for the start menu folder and a desktop icon:

```xml
<!-- Directories -->
<Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
        <!-- Program Files Folder -->
        <Directory Id="ProgramFilesFolder">
            <Directory Id="MANUFACTURERFOLDER" Name="!(bind.property.Manufacturer)">
                <Directory Id="INSTALLFOLDER" Name="!(bind.property.ProductName)" />
            </Directory>
        </Directory>
        <!-- Start Menu Folder -->
        <Directory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="!(bind.property.ProductName)" />
        </Directory>
        <!-- Desktop Shortcut -->
        <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>
</Fragment>

<!-- Provide application and uninstall shortcuts in the start menu-->
<Fragment>
    <ComponentGroup Id="ApplicationShortcuts">
        <Component Id="ApplicationShortcuts" Guid="{E1067E54-F63E-4046-BE28-77E9EDFF504E}" Directory="ApplicationProgramsFolder">
            <Shortcut Id="ApplicationShortcut" Name="$(var.ShortcutName)" Description="Starts $(var.ShortcutName)" Target="[INSTALLFOLDER]$(var.ProductTargetExe)" WorkingDirectory="INSTALLFOLDER" />
            <Shortcut Id="UninstallShortcut" Name="Uninstall !(bind.property.ProductName)" Description="Uninstalls !(bind.property.ProductName)" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
            <RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationShortcutsInstalled" Type="integer" Value="1" KeyPath="yes" />
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        </Component>
    </ComponentGroup>
</Fragment>

<!-- Create a Desktop Shortcut -->
<Fragment>
    <ComponentGroup Id="ApplicationDesktopShortcut">
        <Component Id="ApplicationDesktopShortcut" Guid="{2C44F8C0-EF77-4E73-9EF9-CCD2F92C8A31}" Directory="DesktopFolder">
            <Shortcut Id="ApplicationDesktopShortcut" Name="$(var.ShortcutName)" Description="$(var.ShortcutName)" Target="[INSTALLFOLDER]$(var.ProductTargetExe)" WorkingDirectory="INSTALLFOLDER" />
            <RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationDesktopShortcutInstalled" Type="integer" Value="1" KeyPath="yes" />
        </Component>
    </ComponentGroup>
</Fragment>
```

The registry entires ensure to have the `KeyPath="yes"` attribute, which is used to check if this is installed or not. This attribute check is used by the installer for repair commands or updates of your software.


#### Components, manually added with Wax extension (not recommended)

The components are the payloads of your installation. These contain the files to deploy. It is a good practice to have a component for each file and each component needs a unique GUID to be identified. Here you can use the WAX VS extension to help you generate most of the needed files entires:

[![open wax](/assets/images/articles/wix-tools-msi/VS-tools-Wax.png)](/assets/images/articles/wix-tools-msi/VS-tools-Wax.png)

[![Wax Editor](/assets/images/articles/wix-tools-msi/Wax-editor.png)](/assets/images/articles/wix-tools-msi/Wax-editor.png)

You can reference the needed project and files with clicking through the editor and then add the needed files with the `+` on the right side. The tool then generates the entires and a new GUID for each generated component.


#### Better dynamic harvesting method with heat.exe (recommended)

Heat ist a part of the Wix Tool set and can generate a list of components based on a directory, a project file or on files themselves. With heat you are able to read from the Project output directory and generate the component list for the installer. This ensures to get all the DLLs from used NuGet Packages on every build and you don't have to manage and monitor them every time you add something new or delete something from your project.

To build the installer with heat, you also have to use variables, xml transform files, post build events and more to get the ideal dynamic installer project with as little manual changes as possible.

One way to do this is to add the PostBuild event in the wixproj file:

```xml
<PropertyGroup>
  <!-- $(TargetFramework) ist hardcoded to net7.0 because Wix is not in SDK style yet -->
  <PreBuildEvent>"$(WIX)bin\heat.exe" dir "$(SolutionDir)$(SolutionName)\bin\$(ConfigurationName)\net7.0" -cg ProductComponents -gg -scom -sreg -sfrag -srd -dr INSTALLFOLDER -var var.WixInstallerEDU.TargetDir -t "$(ProjectDir)RemoveExeFiles.xslt" -out "$(ProjectDir)ProductComponents.wxs"</PreBuildEvent>
</PropertyGroup>
```

You can even add batch before harvesting if you need some additional operations on the files:

```xml
<PropertyGroup>
  <!-- $(TargetFramework) ist hardcoded to net7.0 because Wix is not in SDK style yet -->
  <PreBuildEvent>
SET ClientOutputDir=$(SolutionDir)$(SolutionName)\bin\$(ConfigurationName)\net7.0
IF DEFINED SETUP_ENVIRONMENT (
  IF "%SETUP_ENVIRONMENT%"=="BETA" (
    COPY %ClientOutputDir%\serversettings.Test.json %ClientOutputDir%\serversettings.json /y
  )
  IF "%SETUP_ENVIRONMENT%"=="DEVELOPMENT" (
    COPY %ClientOutputDir%\serversettings.Development.json %ClientOutputDir%\serversettings.json /y
  )
) ELSE (
  COPY %ClientOutputDir%\serversettings.Production.json %ClientOutputDir%\serversettings.json /y
)

"$(WIX)bin\heat.exe" dir "%ClientOutputDir%" -cg ProductComponents -gg -scom -sreg -sfrag -srd -dr INSTALLFOLDER -var var.OttoChemie.Client.Dashboard.TargetDir -t "$(ProjectDir)Transforms.xslt" -out "$(ProjectDir)ProductComponents.wxs"
  </PreBuildEvent>
</PropertyGroup>
```

The heat.exe parameters ensure to only harvest the dlls and the important files. The RemoveExeFiles.xslt transformation file is used to exclude all .exe files from this process, because we need to add the main exe file manually for the dynamically gathered version number from this file.

*Small Advice:*
Add a new `.gitignore` file to exclude the generated `ProductComponents.wxs` file:

```git
# Ignore dynamically generated ProductComponents.wxs file from harvesting process
ProductComponents.wxs
```


#### optional Features

You can define some Components or even ComponentGroups as additional/optional Features:

```xml
<!-- List of Componentgroups for a feature to be installed -->
<Feature Id="ProductFeatures" Title="$(var.ProductName).Setup" Level="1" Description="Installs the sample application." Absent="disallow">
	<ComponentGroupRef Id="MainExeComponentGroup" />
	<ComponentGroupRef Id="ProductComponents" />
	<ComponentGroupRef Id="ApplicationShortcuts" />
	<ComponentGroupRef Id="ApplicationDesktopShortcut" />
</Feature>

<!-- optional additional feature to be installed if chosen -->
<Feature Id="OptionalFeatures" Title="OptionalFeatures.Setup" Level="2" Description="install optional Features.">
	<ComponentGroupRef Id="OptionalFeaturesComponents" />
</Feature>
```

The `OptionalFeatures` have a lower Level than the default level 1, so they are not installed by default. You can change the default installation level to 3 with `<Property Id="INSTALLLEVEL" Value=3 />`. Every feature which is above this level will not be installed by default then. 

A possible approach to have optional feature components is to harvest the minimum files per heat.exe and exclude optional files by name with the Transform.xslt. Then add the needed files manually in a Componentgroup and as non default Features again. 

If you choose to not have a GUI installer, then you can add the installation of these features with the console call:

```cmd
msiexec /i WixInstallerEDU.Setup.msi ADDLOCAL=ProductFeatures,OptionalFeatures
```

#### GUI

[![optional Features](/assets/images/articles/wix-tools-msi/optionalFeatures.png)](/assets/images/articles/wix-tools-msi/optionalFeatures.png)

For a minimalistic GUI you can enable some prebuilt dialogs in the Product.wxs file:

```xml
<UIRef Id="WixUI_FeatureTree" />
<WixVariable Id="WixUILicenseRtf" Value="$(var.ProductProjectIconDir)Resources\License.rtf" />
```

These two lines enable a license screen and the selection of features for installation. Create a rtf license file with a rtf editor for proper display.
Other dialogs can be looked up here: [Wix Dialog options](https://wixtoolset.org/docs/v3/wixui/wixui_dialog_library/)

#### Versioning

To sync the version we have to read the version number from a payload file, e.g. the exe file from the project. This file is manually added as separate Fragment, Component Group and Component and gets a certain ID to be referenced in the variables on the top in the variable definitions:

```xml
<?define ProductVersion="!(bind.FileVersion.MainExeFile)" ?>
<!-- ... -->
<!-- manually added exe file to get the version number -->
<!-- all other components will be harvested by post build event and heat.exe on each build -> ProductComponents.wxs -->
<Fragment>
    <ComponentGroup Id="MainExeComponentGroup" Directory="INSTALLFOLDER">
        <Component Id="MainExeComponent" Guid="{F63DFDB3-6C46-46E0-97FA-729C035A5B6F}">
            <File Id="MainExeFile" KeyPath="yes" Source="$(var.ProductTargetDir)$(var.ProductName).exe" />
        </Component>
    </ComponentGroup>
</Fragment>
```

#### Transforming the XML for excluding files

The Transforms.xslt contains transformation commands to prepare the ProductComponent.wsx file before the Setup Build Process reads it. The transform file commands can be used to exclude the manually added exe, the pdb files and the serversettings.json file, which we prepare in another PreBuild Event step. The transforming happens after heat has harvested the Setup file components and transforms the outcome, the ProductComponent.wsx

It only uses the XSLT V1.0 and is very ugly to change, so read the surrounding comments if you have to change something.

For more details check the XSLT Documentation: [xpath (german)](https://www.obqo.de/w3c-trans/xpath-de/)

## CI Build Pipe

The CI build pipe now also builds the MSI package. This can be copied to the staging folder separately and could be deployed to an admin share.

[![DevOps Drop](/assets/images/articles/wix-tools-msi/drop.png)](/assets/images/articles/wix-tools-msi/drop.png)


# Further Information

If you need more MSI functionality or want to look deeper, then check these links:

* [Creating Professional Installations with WiX](https://www.youtube.com/watch?v=usOh3NQO9Ms)
* [Example GitHub for the Youtube Tutorial](https://github.com/SteveIves/SynergyWixExample)


# Full file contents

## Product.wxs

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!-- define dynamic variables here -->
	<?define ProductName="WixInstallerEDU" ?>
	<?define ProductManufacturer="Hermann Otto GmbH" ?>
	<?define ProductVersion="!(bind.FileVersion.MainExeFile)" ?>
	<?define ProductTargetExe="$(var.ProductName).exe" ?>
	<?define ProductTargetDir=$(var.WixInstallerEDU.TargetDir) ?>
	<?define ProductProjectIconDir=$(var.WixInstallerEDU.ProjectDir) ?>
	<?define ProductHelpLink=https://dev.azure.com/OttoChemie/Ausbildung/_git/WixInstallerEDU?>

	<!-- Conditional Block checking if env var exists and if it has specific value for changing the Shortcut name -->
	<?ifdef env.SETUP_ENVIRONMENT?>
	<?if $(env.SETUP_ENVIRONMENT)=BETA?>
	<?define ShortcutName="WixInstallerEDU - BETA" ?>
	<?endif?>
	<?else?>
	<?define ShortcutName="WixInstallerEDU - NEU" ?>
	<?endif?>

	<Product Id="*"
			 Name="$(var.ProductName)"
			 Language="1033"
			 Version="$(var.ProductVersion)"
			 Manufacturer="$(var.ProductManufacturer)"
			 UpgradeCode="{EDE5B0CC-A225-4CFF-AF5D-C40E029BB5AF}">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

		<!-- Pack all files, inlcuding the cab archive into the MSI -->
		<MediaTemplate EmbedCab="yes" />

		<!-- UI and Licensefile as rtf -->
		<!--<UIRef Id="WixUI_FeatureTree" />
		<WixVariable Id="WixUILicenseRtf" Value="$(var.ProductProjectIconDir)Resources\License.rtf" />-->

		<!-- List of Componentgroups for a feature to be installed -->
		<Feature Id="ProductFeatures" Title="$(var.ProductName).Setup" Level="1" Description="Installs the sample application." Absent="disallow">
			<ComponentGroupRef Id="MainExeComponentGroup" />
			<ComponentGroupRef Id="ProductComponents" />
			<ComponentGroupRef Id="ApplicationShortcuts" />
			<ComponentGroupRef Id="ApplicationDesktopShortcut" />
		</Feature>

		<!-- optional additional feature to be installed if chosen -->
		<Feature Id="OptionalFeatures" Title="OptionalFeatures.Setup" Level="2" Description="install optional Features.">
			<ComponentGroupRef Id="OptionalFeaturesComponents" />
		</Feature>

		<!-- Conditional Block checking if env var exists and if it has specific value for changing the Shortcut name -->
		<!-- This only sets a icon for the programmed application UI, not for the shortcut or the start menu -->
		<?ifdef env.SETUP_ENVIRONMENT?>
		<?if $(env.SETUP_ENVIRONMENT)=BETA?>
		<Icon Id="AppIcon" SourceFile="$(var.ProductProjectIconDir)Resources\Raging.ico" />
		<Property Id="ARPPRODUCTICON" Value="AppIcon" />
		<?endif?>
		<?else?>
		<Icon Id="AppIcon" SourceFile="$(var.ProductProjectIconDir)Resources\Icon.ico" />
		<Property Id="ARPPRODUCTICON" Value="AppIcon" />
		<?endif?>

		<!-- Provide information links to be displayed in "Programs and Features" -->
		<Property Id="ARPURLINFOABOUT"  Value="$(var.ProductHelpLink)" />
		<Property Id="ARPHELPLINK"      Value="$(var.ProductHelpLink)" />
		<Property Id="ARPURLUPDATEINFO" Value="$(var.ProductHelpLink)" />
	</Product>

	<!-- Directories -->
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<!-- Program Files Folder -->
			<Directory Id="ProgramFilesFolder">
				<Directory Id="MANUFACTURERFOLDER" Name="!(bind.property.Manufacturer)">
					<Directory Id="INSTALLFOLDER" Name="!(bind.property.ProductName)" />
				</Directory>
			</Directory>
			<!-- Start Menu Folder -->
			<Directory Id="ProgramMenuFolder">
				<Directory Id="ApplicationProgramsFolder" Name="!(bind.property.ProductName)" />
			</Directory>
			<!-- Desktop Shortcut -->
			<Directory Id="DesktopFolder" Name="Desktop" />
		</Directory>
	</Fragment>

	<!-- Provide application and uninstall shortcuts in the start menu-->
	<Fragment>
		<ComponentGroup Id="ApplicationShortcuts">
			<Component Id="ApplicationShortcuts" Guid="{7594FFA1-8A8E-4805-BF45-9959B2B99DC0}" Directory="ApplicationProgramsFolder">
				<Shortcut Id="ApplicationShortcut" Name="$(var.ShortcutName)" Description="Starts $(var.ShortcutName)" Target="[INSTALLFOLDER]$(var.ProductTargetExe)" WorkingDirectory="INSTALLFOLDER" />
				<Shortcut Id="UninstallShortcut" Name="Uninstall !(bind.property.ProductName)" Description="Uninstalls !(bind.property.ProductName)" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
				<RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationShortcutsInstalled" Type="integer" Value="1" KeyPath="yes" />
				<RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<!-- Create a Desktop Shortcut -->
	<Fragment>
		<ComponentGroup Id="ApplicationDesktopShortcut">
			<Component Id="ApplicationDesktopShortcut" Guid="{0C95E742-8971-43F6-BAA4-B98F4C604173}" Directory="DesktopFolder">
				<Shortcut Id="ApplicationDesktopShortcut" Name="$(var.ShortcutName)" Description="$(var.ShortcutName)" Target="[INSTALLFOLDER]$(var.ProductTargetExe)" WorkingDirectory="INSTALLFOLDER" />
				<RegistryValue Root="HKCU" Key="Software\!(bind.property.Manufacturer)\!(bind.property.ProductName)" Name="ApplicationDesktopShortcutInstalled" Type="integer" Value="1" KeyPath="yes" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<!-- manually added exe file to get the version number -->
	<!-- all other components will be harvestet by post build event and heat.exe on each build -> ProductComponents.wxs -->
	<Fragment>
		<ComponentGroup Id="MainExeComponentGroup" Directory="INSTALLFOLDER">
			<Component Id="MainExeComponent" Guid="{F63DFDB3-6C46-46E0-97FA-729C035A5B6F}">
				<File Id="MainExeFile" KeyPath="yes" Source="$(var.ProductTargetDir)$(var.ProductTargetExe)" />
			</Component>
		</ComponentGroup>
	</Fragment>

	<!-- manually added optional feature components -->
	<!-- all other components will be harvestet by post build event and heat.exe on each build -> ProductComponents.wxs -->
	<Fragment>
		<ComponentGroup Id="OptionalFeaturesComponents" Directory="INSTALLFOLDER">
			<Component Id="Feature01Comp" Guid="{C3A936A9-EF50-491D-9A91-BFF37345BE7B}">
				<File Id="Feature01File" KeyPath="yes" Source="$(var.ProductTargetDir)Feature01.txt" />
			</Component>
			<Component Id="Feature02Comp" Guid="{041FF6F3-237C-4D44-A72B-ED7BFE983DA0}">
				<File Id="Feature02File" KeyPath="yes" Source="$(var.ProductTargetDir)Feature02.txt" />
			</Component>
			<Component Id="Feature03Comp" Guid="{CA6A45D8-F3D5-4C9C-979A-550A4E9451E3}">
				<File Id="Feature03File" KeyPath="yes" Source="$(var.ProductTargetDir)Feature03.txt" />
			</Component>
		</ComponentGroup>
	</Fragment>
</Wix>
```


## Transforms.xslt Transform file to exclude exe file from harvesting

```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:wix="http://schemas.microsoft.com/wix/2006/wi"
    xmlns="http://schemas.microsoft.com/wix/2006/wi"

    version="1.0"
    exclude-result-prefixes="xsl wix">

	<xsl:output method="xml" indent="yes" omit-xml-declaration="yes" />
	<xsl:strip-space elements="*" />

	<!--
    Find all <Component> elements with <File> elements with Source="" attributes ending in ".exe" and tag it with the "ExeToRemove" key.

    <Component Id="cmpSYYKP6B1M7WSD5KLEQ7PZW4YLOPYG61L" Directory="INSTALLDIR" Guid="*">
        <File Id="filKUS7ZRMJ0AOKDU6ATYY6IRUSR2ECPDFO" KeyPath="yes" Source="!(wix.StagingAreaPath)\ProofOfPEqualsNP.exe" />
    </Component>

    Because WiX's Heat.exe only supports XSLT 1.0 and not XSLT 2.0 we cannot use `ends-with( haystack, needle )` (e.g. `ends-with( wix:File/@Source, '.exe' )`...
    ...but we can use this longer `substring` expression instead (see https://github.com/wixtoolset/issues/issues/5609 )
    -->
	<!-- Get the last 4 characters of a string using `substring( s, len(s) - 3 )`, it uses -3 and not -4 because XSLT uses 1-based indexes, not 0-based indexes. -->
	<!-- substring( string, start, [length] ) -->
	<xsl:key
        name="ExeToRemove"
        match="wix:Component[ substring( wix:File/@Source, string-length( wix:File/@Source ) - 3 ) = '.exe' ]"
        use="@Id" />

	<!-- Remove all serversettings[.*].json files. The serversettings.json will be added manually -->
	<!-- Documentation: https://www.obqo.de/w3c-trans/xpath-de/#strings -->
	<!-- boolean contains(string, string) -->
	<xsl:key
        name="serversettingsToRemove"
        match="wix:Component[ contains( wix:File/@Source, 'serversettings.' ) ]"
        use="@Id" />

	<!-- Remove .pdb files -->
	<xsl:key
        name="PdbToRemove"
        match="wix:Component[ substring( wix:File/@Source, string-length( wix:File/@Source ) - 3 ) = '.pdb' ]"
        use="@Id" />

	<!-- By default, copy all elements and nodes into the output... -->
	<xsl:template match="@*|node()">
		<xsl:copy>
			<xsl:apply-templates select="@*|node()" />
		</xsl:copy>
	</xsl:template>

	<!-- ...but if the element has a filtered key then don't render anything (i.e. removing it from the output) -->
	<xsl:template match="*[ self::wix:Component or self::wix:ComponentRef ][ key( 'ExeToRemove', @Id ) ]" />
	<xsl:template match="*[ self::wix:Component or self::wix:ComponentRef ][ key( 'serversettingsToRemove', @Id ) ]" />
	<xsl:template match="*[ self::wix:Component or self::wix:ComponentRef ][ key( 'PdbToRemove', @Id ) ]" />
</xsl:stylesheet>
```


# Silent (un)installation

To install the MSI package silently you have to open a console with admin privileges. Then enter the following command variants for installation:

Silent install or silent major upgrade:
```shell
msiexec.exe /i foo.msi /qn
```

Silent minor upgrade:
```shell
msiexec.exe /i foo.msi REINSTALL=ALL REINSTALLMODE=vomus /qn
```

Silent uninstall:
```shell
msiexec.exe /i foo.msi /qn
```

Executable path of msiexec:
```shell
msiexec.exe /i foo.msi /qn
```
